{% extends '_layout.html' %}

{% block title %}Dashboard{% endblock %}
{% block body %}

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f0f2f5;
    }

    .dashboard {
        display: flex;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
        gap: 20px;
    }

    .column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .module {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px 15px 30px 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        flex-shrink: 0;
        overflow-y: auto;
    }

    h2{
        font-size: 18px;
        margin: 0 0 10px;
        font-weight: 700;
    }

    /* Heights for each modular section */
    .height-25 {
        height: 25%;
    }

    .height-35 {
        height: 35%;
    }

    .height-50 {
        height: 50%;
    }
    .height-40 {
        height: 40%;
    }
    .height-60 {
        height: 60%;
    }

    .height-75 {
        height: 75%;
    }

    .fill {
        flex: 1;
        overflow-y: auto;
    }

    canvas {
        max-width: 100%;
        height: auto;
    }

    h2, h3 {
        margin: 0 0 10px;
    }

    ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    li {
        margin-bottom: 8px;
    }

    .net-worth-value {
        font-size: 28px; 
        font-weight: bold; 
        margin-top: 10px;
    }
    .net-worth-box {
        display: flex;
        flex-direction: column;
        justify-content: center; 
        align-items: center;     
        text-align: center;
    }

    .module.height-25 {
        height: 25%;  
        overflow-y: auto; 
        padding-right: 10px;  
    }

    .spending-item {
        display: flex;
        flex-direction: column;  
        margin-bottom: 15px; 
    }
    
    .spending-details {
        display: flex;
        justify-content: space-between;  
        font-weight: bold; 
    }
    
    .spending-item-name {
        flex: 1;
        text-align: left;   
    }
    
    .spending-amount {
        text-align: right;  
    }
    
    .spending-date {
        font-size: 12px;      
        color: #888;       
        text-align: left; 
        margin-top: 5px;
    }

    .module.height-35 {
        height: 35%; 
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .expense-item {
        display: flex;
        justify-content: space-between; 
        margin-bottom: 15px; 
    }
    
    .expense-name {
        flex: 1;
        text-align: left; 
    }
    
    .expense-amount {
        text-align: right;
    }

    .progress-container {
        background-color: #eee;
        border-radius: 10px;
        overflow: hidden;
        height: 15px;
        margin-top: 5px;
    }
    
    .progress-bar {
        height: 100%;
        text-align: right;
        padding-right: 5px;
        color: white;
        line-height: 15px;
        font-size: 12px;
        transition: width 0.6s ease-in-out;
        border-radius: 10px;
    }
    .progress-bar.low {
        background-color: #e74c3c;  /* Red */
    }
    .progress-bar.medium {
        background-color: #f1c40f;  /* Yellow */
    }
    .progress-bar.high {
        background-color: #2ecc71;  /* Green */
    }

    .health-score-module canvas {
        max-height: 120px;
    }

    .health-score-module {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
</style>

<div class="dashboard">

    <!-- Column 1: Net Worth -->
    <div class="column">
        <div class="module height-25 net-worth-box">
            <h2>Your Estimated Net Worth</h2>
            <p class="net-worth-value">${{ net_worth }}</p>
        </div>
        <div class="module height-75 fill">
            <h2>Asset Distribution</h2>
            <canvas id="netWorthDonutChart"></canvas>
            <h2>Assets</h2>
            <ul>
                {% for asset in assets %}
                    <li>{{ asset.name }}: ${{ asset.value }}</li>
                {% else %}
                    <li>No assets added yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Column 2: Spending -->
    <div class="column">
        <div class="module height-50">
            <h2>Spending Activity</h2>
            <ul>
                {% for s in spendings %}
                    <li class="spending-item">
                        <div class="spending-details">
                            <span class="spending-item-name">{{ s.item }}</span>
                            <span class="spending-amount">${{ s.amount }}</span>
                        </div>
                        <span class="spending-date">{{ s.date }}</span>
                    </li>
                {% else %}
                    <li>No spending records yet.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="module height-50">
            <h2>Income vs Expense</h2>
            <canvas id="incomeVsExpenseChart"></canvas>
        </div>
    </div>
    <!-- Column 3 Savings-->
    <div class="column">
        <div class="module height-50">
            <h2>Savings Goals</h2>
            {% if savings_goals %}
        <ul>
        {% for goal in savings_goals %}
            <li style="margin-bottom: 15px;">
                <strong>{{ goal.item }}</strong>: ${{ goal.current_amount }} / ${{ goal.cost }}
                <div class="progress-container">
                    <div class="progress-bar 
                        {% if goal.progress_percent < 50 %}low
                        {% elif goal.progress_percent < 80 %}medium
                        {% else %}high
                        {% endif %}"
                        style="width: {{ goal.progress_percent }}%;">
                        {{ goal.progress_percent | round(0) }}%
                </div>               
                {% if goal.is_funded %}
                    <span style="color: green;">Goal reached! ðŸŽ‰</span>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No savings goals added yet.</p>
    {% endif %}
        </div>
        
        <div class="module height-50 health-score-module">
            <h2>Financial Health Score</h2>
            <canvas id="healthGauge"></canvas>
            <p style="text-align: center; font-size: 18px; margin-top: 10px;">
                Score: <strong>{{ health_score }}</strong>/100
            </p>
        </div>
    </div>

    <!-- Column 4: Investments -->
    <div class="column">
        <div class="module height-40">
            <h2>Investment Trends</h2>
            <canvas id="investmentLineChart"></canvas>
        </div>
        
        <div class="module height-60">
            <h2>Investment Allocation</h2>
            <canvas id="investmentDonutChart"></canvas>
            <h2>Investments</h2>
            <ul>
                {% for inv in investments %}
                    <li>{{ inv.stock_name }}: ${{ inv.amount or 'N/A' }}</li>
                {% else %}
                    <li>No investments added yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

</div>

<!-- Script for chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Donut chart for net_worth
    var ctx = document.getElementById('netWorthDonutChart').getContext('2d');

    var labels = [{% for asset in assets %}"{{ asset.name }}"{% if not loop.last %}, {% endif %}{% endfor %}];
    var data = [{% for asset in assets %}{{ asset.value }}{% if not loop.last %}, {% endif %}{% endfor %}];

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: ['#003300', '#006600', '#009933', '#33cc33', '#99ff99'],
            }]
        }
    });
    


    // Donut chart for investments
    var ctx2 = document.getElementById('investmentDonutChart').getContext('2d');

    var investmentLabels = [{% for inv in investments %}"{{ inv.stock_name }}"{% if not loop.last %}, {% endif %}{% endfor %}];
    var investmentAmounts = [{% for inv in investments %}{{ inv.amount or 0 }}{% if not loop.last %}, {% endif %}{% endfor %}];

    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: investmentLabels,
            datasets: [{
                data: investmentAmounts,
                backgroundColor: ['#003300', '#006600', '#009933', '#33cc33', '#99ff99'],
            }]
        }
    });
    //financial health gauge
    const healthGauge = document.getElementById('healthGauge').getContext('2d');

    const score = {{ health_score | default(0) }};  // passed from Flask
    const remaining = 100 - score;

    let backgroundColor = [];
    // Set color based on the score
    if (score <= 30) {
        backgroundColor = ['#ff5f5f', '#e0e0e0']; // Red for low score
    } else if (score <= 70) {
        backgroundColor = ['#ffbf00', '#e0e0e0']; // Yellow for medium score
    } else {
        backgroundColor = ['#4caf50', '#e0e0e0']; // Green for high score
    }

    new Chart(healthGauge, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, remaining],
                backgroundColor: backgroundColor,
                borderWidth: 0
            }]
        },
        options: {
            rotation: -90,
            circumference: 180,
            cutout: '80%',
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });

    //Investment history line chart
    async function renderMultiStockChart(symbols) {
        const response = await fetch('/stock-history?' + symbols.map(s => `symbol=${s}`).join('&'));
        const data = await response.json();
       


        const colors = ['#003300', '#006600', '#009933', '#33cc33', '#99ff99'];
        const datasets = [];


        symbols.forEach((symbol, index) => {
            const stockData = data[symbol] || [];
            const prices = stockData.map(d => d.close);


            datasets.push({
                label: symbol,
                data: prices,
                borderColor: colors[index % colors.length],
                fill: false,
                tension: 0.1
            });
        });


        const ctx5 = document.getElementById('investmentLineChart').getContext('2d');
        new Chart(ctx5, {
            type: 'line',
            data: {
                labels: data[symbols[0]] ? data[symbols[0]].map(d => d.date) : [],
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Date' }
                    },
                    y: {
                        title: { display: true, text: 'Price ($)' }
                    }
                }
            }
        });
    }


    // Auto-load all user's stock investments
    const stockSymbols = [{% for inv in investments %}"{{ inv.stock_name }}"{% if not loop.last %}, {% endif %}{% endfor %}];
    if (stockSymbols.length > 0) {
        renderMultiStockChart(stockSymbols);
    }


    

</script>

{% endblock %}