{% extends '_layout.html' %}

{% block title %}Dashboard{% endblock %}
{% block body %}
<style>
    .btn-area {
      float: right;
      margin-bottom: 1rem;
    }
  </style>
  <div class="main">
    <div class="btn-area">
      <button id="closeFormBtn" class="btn btn-danger" style="display:none;" onclick="toggleForm(false)">&times;</button>
      <button class="btn btn-primary" onclick="toggleForm(true)">New</button>
      <button class="btn btn-secondary">Edit</button>
    </div>
  
    <div id="dataForm" style="display: none">
      <form onsubmit="submitForm(event)">
        <div class="mb-3">
          <label>Income Type</label><br>
          <input type="radio" name="income_type" value="salary" checked onclick="toggleIncomeFields('salary')"> Yearly Salary
          <input type="radio" name="income_type" value="hourly" onclick="toggleIncomeFields('hourly')"> Hourly Wage
        </div>
        <div id="salaryField" class="mb-3">
          <label>Yearly Income</label>
          <input type="number" class="form-control" id="income">
        </div>
        <div id="hourlyFields" style="display: none;">
          <div class="mb-3">
            <label>Hourly Wage</label>
            <input type="number" class="form-control" id="hourly_wage">
          </div>
          <div class="mb-3">
            <label>Hours per Week</label>
            <input type="number" class="form-control" id="hours_per_week">
          </div>
        </div>
        <div class="mb-3">
          <label>Account Balance</label>
          <input type="number" class="form-control" id="balance" required>
        </div>
        <div class="mb-3">
          <label>Minimum Balance (Optional)</label>
          <input type="number" class="form-control" id="min_balance">
        </div>
        <div id="expenseSection">
          <label>Expenses</label>
          <div id="expensesContainer"></div>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addExpense()">+ Add Expense</button>
        </div>
        <div id="budgetSection" class="mt-4">
          <label>Budget Items</label>
          <div id="budgetItemsContainer"></div>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addBudgetItem()">+ Add Budget Item</button>
        </div>
        <button class="btn btn-success mt-3">Submit</button>
      </form>
    </div>
  
    {% if latest %}
    <hr>
    <h4>Latest Data</h4>
    <p><strong>Income:</strong> ${{ latest.income }}</p>
    <p><strong>Account Balance:</strong> ${{ latest.balance }}</p>
    {% if latest.min_balance %}
      <p><strong>Minimum Balance Goal:</strong> ${{ latest.min_balance }}</p>
    {% endif %}
    <h5>Budget Summary</h5>
<p>Weekly Income: ${{ calculations.weekly_income }}</p>
<p>Monthly Income: ${{ calculations.monthly_income }}</p>
<p>Yearly Income: ${{ calculations.yearly_income }}</p>
<p>Monthly Expenses: ${{ calculations.monthly_expenses }}</p>
<p>Free to Spend After Expenses + Minimum Balance: 
  <span class="{{ 'text-success' if calculations.free_to_spend >= 0 else 'text-danger' }}">
    ${{ calculations.free_to_spend }}
  </span>
</p>
<h5>Budget Goals</h5>
    <ul>
      {% for item in calculations.budget_items %}
        <li>{{ item.name }} - {{ item.display }} - {{ item.progress }} complete ({{ item.time_to_save }})</li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  
  <script>
  function toggleForm(show) {
    const form = document.getElementById('dataForm');
    const closeBtn = document.getElementById('closeFormBtn');
    if (show) {
      form.style.display = 'block';
      closeBtn.style.display = 'inline-block';
    } else {
      form.style.display = 'none';
      closeBtn.style.display = 'none';
    }
  }
  
  function toggleIncomeFields(type) {
    document.getElementById('hourlyFields').style.display = type === 'hourly' ? 'block' : 'none';
    document.getElementById('salaryField').style.display = type === 'salary' ? 'block' : 'none';
  }
  
  function addExpense() {
    const container = document.getElementById('expensesContainer');
    const div = document.createElement('div');
    div.classList.add('mb-2');
    div.innerHTML = `
      <input class="form-control mb-1" type="text" placeholder="Label (e.g. Food)" name="expense_label">
      <input class="form-control mb-1" type="number" placeholder="Cost" name="expense_cost">
      <select class="form-control mb-1" name="expense_frequency">
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
    `;
    container.appendChild(div);
  }
  
  function addBudgetItem() {
    const container = document.getElementById('budgetItemsContainer');
    const div = document.createElement('div');
    div.classList.add('mb-2');
    div.innerHTML = `
      <input class="form-control mb-1" type="text" placeholder="Item Name" name="budget_name">
      <input class="form-control mb-1" type="number" placeholder="Cost" name="budget_cost">
    `;
    container.appendChild(div);
  }
  
  function submitForm(e) {
    e.preventDefault();
    const incomeType = document.querySelector('input[name="income_type"]:checked').value;
    let income = 0, hourly_wage = 0, hours_per_week = 0;
    if (incomeType === 'hourly') {
      hourly_wage = parseFloat(document.getElementById('hourly_wage').value);
      hours_per_week = parseFloat(document.getElementById('hours_per_week').value);
    } else {
      income = parseFloat(document.getElementById('income').value);
    }
    const balance = parseFloat(document.getElementById('balance').value);
    const min_balance = parseFloat(document.getElementById('min_balance').value) || 0;
  
    const expenseEls = document.querySelectorAll('#expensesContainer > div');
    const expenses = Array.from(expenseEls).map(div => {
      const inputs = div.querySelectorAll('input, select');
      return {
        label: inputs[0].value,
        cost: parseFloat(inputs[1].value),
        frequency: inputs[2].value
      };
    });
  
    const budgetEls = document.querySelectorAll('#budgetItemsContainer > div');
    const budget_items = Array.from(budgetEls).map(div => {
      const inputs = div.querySelectorAll('input');
      return {
        name: inputs[0].value,
        cost: parseFloat(inputs[1].value)
      };
    });
  
    fetch('/submit_financial_data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ income_type: incomeType, income, hourly_wage, hours_per_week, balance, min_balance, expenses, budget_items })
    }).then(res => location.reload());
  }
  </script>
{% endblock %}